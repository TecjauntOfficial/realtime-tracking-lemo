<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Limo Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        :root {
            --primary: #ff6b35;
            --primary-light: #ff8c61;
            --secondary: #f7c59f;
            --background: #fffaf7;
            --text: #2b2b2b;
            --card: #ffffff;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
            display: inline-block;
        }

        .connected { background-color: var(--success); }
        .disconnected { background-color: var(--error); }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .analytics-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .chart-container {
            height: 300px;
        }

        .active-sockets {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .socket-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .socket-card {
            background: var(--background);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .socket-card.active {
            border-left-color: var(--success);
        }

        .socket-card h4 {
            margin-bottom: 8px;
        }

        .socket-stats {
            font-size: 0.9em;
            color: #666;
        }

        .events-container {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #clear-logs {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .event-card {
            background: var(--background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .event-card.received { border-left-color: var(--success); }
        .event-card.sent { border-left-color: var(--warning); }

        .error-message {
            background-color: #ffebee;
            color: var(--error);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Enhanced Limo Analytics Dashboard</h1>
            <p>Real-time monitoring and analytics</p>
            <div id="connection-status" class="connection-status disconnected">Disconnected</div>
        </div>

        <div id="error-message" class="error-message"></div>

        <div class="grid-container">
            <div class="analytics-card">
                <h3>Event Distribution</h3>
                <div class="chart-container">
                    <canvas id="eventDistributionChart"></canvas>
                </div>
            </div>
            <div class="analytics-card">
                <h3>Real-time Event Rate</h3>
                <div class="chart-container">
                    <canvas id="eventRateChart"></canvas>
                </div>
            </div>
        </div>

        <div class="active-sockets">
            <h3>Active Connections</h3>
            <div id="socket-list" class="socket-list"></div>
        </div>

        <div class="events-container">
            <div class="events-header">
                <h2>Event Log</h2>
                <button id="clear-logs">Clear Logs</button>
            </div>
            <div id="event-log"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Analytics state
        const state = {
            sockets: new Map(),
            events: {
                total: 0,
                received: 0,
                sent: 0
            },
            eventHistory: [],
            charts: {}
        };

        // Initialize socket
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // Initialize charts
        function initializeCharts() {
            // Event Distribution Chart
            state.charts.distribution = new Chart(
                document.getElementById('eventDistributionChart'),
                {
                    type: 'doughnut',
                    data: {
                        labels: ['Received', 'Sent'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: [
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(255, 152, 0, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                }
            );

            // Event Rate Chart
            state.charts.rate = new Chart(
                document.getElementById('eventRateChart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Events per minute',
                            data: [],
                            borderColor: 'rgba(255, 107, 53, 1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
        }

        // Update socket information
        function updateSocketInfo(socketId, eventType, data) {
            if (!state.sockets.has(socketId)) {
                state.sockets.set(socketId, {
                    id: socketId,
                    eventCount: 0,
                    lastActive: new Date(),
                    events: {}
                });
            }

            const socketInfo = state.sockets.get(socketId);
            socketInfo.eventCount++;
            socketInfo.lastActive = new Date();
            socketInfo.events[eventType] = (socketInfo.events[eventType] || 0) + 1;

            updateSocketDisplay();
        }

        // Update socket display
        function updateSocketDisplay() {
            const container = document.getElementById('socket-list');
            container.innerHTML = '';

            state.sockets.forEach(socketInfo => {
                const card = document.createElement('div');
                card.className = `socket-card ${isSocketActive(socketInfo) ? 'active' : ''}`;
                card.innerHTML = `
                    <h4>Socket: ${socketInfo.id}</h4>
                    <div class="socket-stats">
                        <div>Events: ${socketInfo.eventCount}</div>
                        <div>Last Active: ${formatTime(socketInfo.lastActive)}</div>
                        <div>Event Types: ${Object.keys(socketInfo.events).join(', ')}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function isSocketActive(socketInfo) {
            return (new Date() - socketInfo.lastActive) < 30000; // 30 seconds
        }

        // Update charts
        function updateCharts() {
            // Update distribution chart
            state.charts.distribution.data.datasets[0].data = [
                state.events.received,
                state.events.sent
            ];
            state.charts.distribution.update();

            // Update rate chart
            const now = new Date();
            const minute = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            state.charts.rate.data.labels.push(minute);
            state.charts.rate.data.datasets[0].data.push(state.eventHistory.length);
            
            if (state.charts.rate.data.labels.length > 10) {
                state.charts.rate.data.labels.shift();
                state.charts.rate.data.datasets[0].data.shift();
            }
            
            state.charts.rate.update();
        }

        // Connection handling
        socket.on('connect', () => {
            updateConnectionStatus(true);
            socket.emit('joinDashboard');
            console.log('Connected to server');
        });

        socket.on('connect_error', (error) => {
            updateConnectionStatus(false);
            showError('Connection error: ' + error.message);
        });

        // Event handling
        socket.on('event', (message) => {
            // Update event counts
            state.events.total++;
            state.events[message.direction]++;
            
            // Update socket information
            updateSocketInfo(message.socketId, message.event, message.data);
            
            // Add to event history
            state.eventHistory.push({
                timestamp: new Date(),
                ...message
            });

            // Update charts
            updateCharts();

            // Add to event log
            addEventToLog(message);
        });

        // Helper functions
        function updateConnectionStatus(connected) {
            const element = document.getElementById('connection-status');
            element.textContent = connected ? 'Connected' : 'Disconnected';
            element.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }

        function showError(message) {
            const element = document.getElementById('error-message');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString();
        }

        function addEventToLog(message) {
            const log = document.getElementById('event-log');
            const card = document.createElement('div');
            card.className = `event-card ${message.direction}`;
            card.innerHTML = `
                <div>
                    <strong>${message.event}</strong>
                    <span style="float: right">${formatTime(message.timestamp)}</span>
                </div>
                <div>Socket: ${message.socketId}</div>
                <pre style="margin-top: 10px">${JSON.stringify(message.data, null, 2)}</pre>
            `;
            log.insertBefore(card, log.firstChild);
        }

        // Initialize
        initializeCharts();

        // Clear logs handler
        document.getElementById('clear-logs').addEventListener('click', () => {
            document.getElementById('event-log').innerHTML = '';
            state.events = { total: 0, received: 0, sent: 0 };
            state.eventHistory = [];
            updateCharts();
        });

        // Periodic cleanup of inactive sockets
        setInterval(() => {
            state.sockets.forEach((info, id) => {
                if (!isSocketActive(info)) {
                    state.sockets.delete(id);
                }
            });
            updateSocketDisplay();
        }, 30000);

        // Update rate chart periodically
        setInterval(() => {
            state.eventHistory = state.eventHistory.filter(
                event => (new Date() - new Date(event.timestamp)) < 60000
            );
            updateCharts();
        }, 60000);
    </script>
</body>
</html>